<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>文字轉注音圖片</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <style>
    @font-face {
      font-family: 'BpmfZihiOnly-R';
      src: url('./font/BpmfSpecial/BpmfZihiOnly-R.ttf') format("truetype");
    }

    @font-face {
      font-family: 'NotoSansTC-Medium';
      src: url('./font/Noto_Sans_TC/static/NotoSansTC-Medium.ttf') format("truetype");
    }

    /* 保持顯示格式 */
    #capture div {
      white-space: pre-wrap;
      /* 保留空白字符和換行 */
    }
  </style>
</head>

<body>
  <div class="container-fluid p-3">
    <div class="row mb-3">
      <div class="col">
        <h1 class="fs-3">歡迎使用文字轉注音圖片服務！</h1>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col">
        <div class="input-group mb-3">
          <span class="input-group-text">輸入文字</span>
          <textarea id="textarea-1" class="form-control" style="overflow: hidden;"></textarea>
        </div>
        <!-- 注音輸入區 -->
        <div class="input-group mb-3">
          <span class="input-group-text">輸入讀音</span>
          <textarea id="textarea-2" class="form-control" style="overflow: hidden;"></textarea>
        </div>
        <div class="input-group mb-3">
          <label class="input-group-text">預設顏色</label>
          <input type="color" class="form-control form-control-color" id="color-input" value="#563d7c"
            title="Choose your color">
        </div>
        <div class="input-group mb-3">
          <span class="input-group-text">自訂顏色</span>
          <textarea id="textarea-3" class="form-control" style="overflow: hidden;"></textarea>
        </div>
        <!-- 中文輸入區 -->

        <!-- 顯示區 -->
        <div class="input-group mb-3">
          <button id="copy-image-btn" class="btn btn-primary w-100">複製圖片到剪貼簿</button>
        </div>
        <div id="capture" class="border position-relative d-inline-block" style="padding: 5px 10px 5px 5px;">
          <div id="text-1" class="position-relative" style="
            margin: 0;
            overflow: hidden;
            font-size: 36px;
            letter-spacing: 22px;
            line-height: 1.3;
            color: #754226;
            top: 0; 
            visibility: hidden;
            font-family: 'NotoSansTC-Medium';">
          </div>
          <div id="text-2" class="position-absolute" style="
            overflow: hidden;
            font-size: 36px;
            letter-spacing: 22px;
            line-height: 1.3;
            color: #754226;
            top: 0; 
            left: 10px; 
            width: 100%;
            font-family: 'NotoSansTC-Medium';">
          </div>
          <div id="text-3" class="position-absolute" style="
            font-size: 36px;
            letter-spacing: 22px;
            line-height: 1.3;
            color: #754226;
            top: 2px;
            left: 36px; 
            width: 100%;
            font-family: 'BpmfZihiOnly-R';">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 引入 html2canvas 庫 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
    integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
    integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
    crossorigin="anonymous"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // 取得 DOM 元素
      function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
      }

      const textarea1 = document.getElementById("textarea-1");
      const textarea2 = document.getElementById("textarea-2");
      const textarea3 = document.getElementById("textarea-3");
      const text1 = document.getElementById("text-1");
      const text2 = document.getElementById("text-2");
      const text3 = document.getElementById("text-3");
      const copyImageBtn = document.getElementById("copy-image-btn");
      const colorInput = document.getElementById("color-input");
      colorInput.value = "#754226";
      text1.style.color = colorInput.value;
      text2.style.color = colorInput.value;
      text3.style.color = colorInput.value;
      colorInput.addEventListener("input", function () {
        text1.style.color = this.value;
        text2.style.color = this.value;
        text3.style.color = this.value;
      });

      // 存儲顏色映射的對象
      let colorMap = {};

      // 解析顏色定義並建立映射
      function parseColorDefinitions(text) {
        const lines = text.split('\n');
        colorMap = {};
        lines.forEach(line => {
          const [name, color] = line.split(':').map(s => s.trim());
          if (name && color) {
            colorMap[name] = color;
          }
        });
      }

      // 處理顏色標籤
      function processColorTags(text) {
        // 先處理自定義顏色標籤
        Object.keys(colorMap).forEach(colorName => {
          const colorValue = colorMap[colorName];
          const regex = new RegExp(`<${colorName}>(.*?)</${colorName}>`, 'g');
          text = text.replace(regex, `<span style="color: ${colorValue}">$1</span>`);
        });

        // 處理直接的十六進制顏色代碼
        return text.replace(/<#([#a-zA-Z0-9]{3,6})>(.*?)<\/#\1>/g, '<span style="color: #$1">$2</span>');
      }

      // 函數：更新顯示區域的文本內容
      function updateTextElements(initial = false) {
        // 更新顏色映射
        parseColorDefinitions(textarea3.value);

        const value1 = textarea1.value;
        const value2 = textarea2.value;

        // 處理顏色標籤
        const processedValue1 = processColorTags(value1);
        const processedValue2 = processColorTags(value2);

        if (initial) {
          text1.innerHTML = processedValue1;
          text2.innerHTML = processedValue1;
          text3.innerHTML = processedValue1;
        } else {
          text1.innerHTML = processedValue1;
          text2.innerHTML = processedValue1;
          text3.innerHTML = processedValue2;
        }
      }

      // 初始化同步
      textarea3.value = `red: #f24f24
blue: #24bbf2
green: #24f265`;

      textarea1.value = `銀<blue>行</blue>
<red>重</red>年
牛仔褲`;

      textarea2.value = `銀<red>航</red>
<red>蟲</red>年
牛<red>崽</red>褲`;

      updateTextElements();
      autoResizeTextarea(textarea1);
      autoResizeTextarea(textarea2);
      autoResizeTextarea(textarea3);

      // 當 textarea1 有變動時
      textarea1.addEventListener("input", function () {
        textarea2.value = textarea1.value;
        updateTextElements();
        autoResizeTextarea(textarea1);
        autoResizeTextarea(textarea2);
        autoResizeTextarea(textarea3);
      });

      // 當 textarea2 有變動時
      textarea2.addEventListener("input", function () {
        updateTextElements();
        autoResizeTextarea(textarea1);
        autoResizeTextarea(textarea2);
        autoResizeTextarea(textarea3);
      });

      // 當 textarea3 有變動時
      textarea3.addEventListener("input", function () {
        updateTextElements();
        autoResizeTextarea(textarea1);
        autoResizeTextarea(textarea2);
        autoResizeTextarea(textarea3);
      });

      // 複製圖片到剪貼簿
      copyImageBtn.addEventListener("click", function () {
        html2canvas(document.querySelector("#capture"), { 
            scale: 2,
            backgroundColor: null 
          }).then(canvas => {
          canvas.toBlob(function (blob) {
            const item = new ClipboardItem({ "image/png": blob });
            navigator.clipboard.write([item]).then(function () {
              alert("圖片已成功複製到剪貼簿！");
            }, function (err) {
              console.error("複製圖片失敗: ", err);
              alert("無法複製圖片到剪貼簿。請檢查瀏覽器是否支援此功能。");
            });
          });
        }).catch(function (error) {
          console.error("截圖失敗: ", error);
          alert("截圖失敗，請檢查瀏覽器控制台以獲取更多資訊。");
        });
      });
    });
  </script>
</body>

</html>
