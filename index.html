<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>文字轉注音圖片</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <style>
    @font-face {
      font-family: 'BpmfZihiOnly-R';
      src: url('./font/BpmfSpecial/BpmfZihiOnly-R.ttf') format("truetype");
    }

    @font-face {
      font-family: 'NotoSansTC-Medium';
      src: url('./font/Noto_Sans_TC/static/NotoSansTC-Regular.ttf') format("truetype");
    }

    /* 保持顯示格式 */
    #capture div {
      white-space: pre-wrap;
      /* 保留空白字符和換行 */
    }

    /* 確保 #capture 及其父元素沒有背景顏色 */
    #capture {
      background-color: transparent;
      /* 設置為透明 */
      padding: 5px 10px 5px 5px;
    }

    .floating-alert {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1050;
      display: none;
    }

    .fade-out {
      animation: fadeOut 0.5s ease-in-out forwards;
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
      }
    }
  </style>
</head>

<body>
  <div class="container-fluid p-3">
    <div class="row mb-3">
      <div class="col">
        <h1 class="fs-3">歡迎使用文字轉注音圖片服務！</h1>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col">
        <iframe src="https://buttaiwan.github.io/bpmfvs/" frameborder="0" style="height: 500px; width: 100%;"></iframe>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col">
        <div class="input-group mb-3">
          <span class="input-group-text">輸入文字</span>
          <textarea id="textarea-1" class="form-control" style="overflow: hidden;"></textarea>
        </div>
        <!-- 注音輸入區 -->
        <div class="input-group mb-3">
          <span class="input-group-text">輸入讀音</span>
          <textarea id="textarea-2" class="form-control" style="overflow: hidden;"></textarea>
        </div>
        <div class="input-group mb-3">
          <label class="input-group-text">預設顏色</label>
          <input type="color" class="form-control form-control-color" id="color-input" value="#563d7c"
            title="Choose your color">
        </div>
        <div class="input-group mb-3">
          <span class="input-group-text">自訂顏色</span>
          <textarea id="textarea-3" class="form-control" style="overflow: hidden;"></textarea>
        </div>
        <!-- 中文輸入區 -->

        <!-- 顯示區 -->
        <div class="input-group mb-3">
          <button id="copy-image-btn" class="btn btn-primary w-100">複製圖片到剪貼簿</button>
        </div>
        <div id="capture" class="position-relative d-inline-block" style="padding: 5px 10px 5px 5px;">
          <div id="text-1" class="position-relative" style="
            margin: 0;
            overflow: hidden;
            font-size: 36px;
            letter-spacing: 24px;
            line-height: 1.3;
            color: #754226;
            top: 0; 
            visibility: hidden;
            font-family: Arial, 'NotoSansTC-Medium';">
          </div>
          <div id="text-2" class="position-absolute" style="
            overflow: hidden;
            font-size: 36px;
            letter-spacing: 24px;
            line-height: 1.3;
            color: #754226;
            top: 0; 
            left: 10px; 
            width: 100%;
            font-family: Arial, 'NotoSansTC-Medium';">
          </div>
          <div id="text-3" class="position-absolute" style="
            font-size: 36px;
            letter-spacing: 24px;
            line-height: 1.3;
            color: #754226;
            top: 2px;
            left: 34px; 
            width: 100%;
            font-weight: 100;
            font-family: Arial, 'BpmfZihiOnly-R';">
          </div>
        </div>
      </div>
    </div>
    <div class="alert alert-success floating-alert" role="alert">
      圖片已成功複製到剪貼簿！
    </div>
  </div>

  <!-- 引入 html2canvas 庫 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
    integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
    integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
    crossorigin="anonymous"></script>
  <script>

    document.addEventListener("DOMContentLoaded", function () {
      // Debounce 函數
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      function showFloatingAlert(message) {
        const alertElement = document.querySelector('.floating-alert');
        alertElement.textContent = message;
        alertElement.style.display = 'block';

        // 3秒後開始淡出
        setTimeout(() => {
          alertElement.classList.add('fade-out');

          // 淡出動畫完成後隱藏元素
          setTimeout(() => {
            alertElement.style.display = 'none';
            alertElement.classList.remove('fade-out');
          }, 500);
        }, 3000);
      }

      // 取得 DOM 元素
      function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
      }

      const textarea1 = document.getElementById("textarea-1");
      const textarea2 = document.getElementById("textarea-2");
      const textarea3 = document.getElementById("textarea-3");
      const text1 = document.getElementById("text-1");
      const text2 = document.getElementById("text-2");
      const text3 = document.getElementById("text-3");
      const copyImageBtn = document.getElementById("copy-image-btn");
      const colorInput = document.getElementById("color-input");

      // 初始化顏色設定
      colorInput.value = "#754226";
      text1.style.color = colorInput.value;
      text2.style.color = colorInput.value;
      text3.style.color = colorInput.value;

      colorInput.addEventListener("input", function () {
        text1.style.color = this.value;
        text2.style.color = this.value;
        text3.style.color = this.value;
      });

      // 存儲顏色映射的對象
      let colorMap = {};

      // 解析顏色定義並建立映射
      function parseColorDefinitions(text) {
        const lines = text.split('\n');
        colorMap = {};
        lines.forEach(line => {
          const [name, color] = line.split(':').map(s => s.trim());
          if (name && color) {
            colorMap[name] = color;
          }
        });
      }

      // 定義中文字符的正則表達式
      const chineseCharRegex = /[^\u4E00-\u9FFF\u3400-\u4DBF\uF900-\uFAFF\u20000-\u2A6DF]/g;

      // 處理顏色標籤並替換非中文字符為空格
      function processColorTags(text, isText2 = false) {
        if (isText2) {
          text = text.replace(chineseCharRegex, '　');
          text = text.replace('...', '');
        }

        if (!isText2) {
          text = text.replace('...', '…');
        }

        Object.keys(colorMap).forEach(colorName => {
          const colorValue = colorMap[colorName];
          const regex = new RegExp(`<${colorName}>(.*?)</${colorName}>`, 'g');
          text = text.replace(regex, `<span style="color: ${colorValue}">$1</span>`);
        });

        return text.replace(/<#([#a-zA-Z0-9]{3,6})>(.*?)<\/#\1>/g, '<span style="color: #$1">$2</span>');
      }

      // 更新顯示區域的文本內容
      function updateTextElements(initial = false) {
        parseColorDefinitions(textarea3.value);
        const value1 = textarea1.value;
        const value2 = textarea2.value;
        const processedValue1 = processColorTags(value1);
        const processedValue2 = processColorTags(value2, true);

        if (initial) {
          text1.innerHTML = processedValue1;
          text2.innerHTML = processedValue1;
          text3.innerHTML = processedValue1;
        } else {
          text1.innerHTML = processedValue1;
          text2.innerHTML = processedValue1;
          text3.innerHTML = processedValue2;
        }
      }

      // 捕捉圖片並複製到剪貼簿
      async function captureAndCopyImage() {
        try {
          window.focus();
          const canvas = await html2canvas(document.querySelector("#capture"), {
            scale: 2,
            backgroundColor: null
          });

          canvas.toBlob(async (blob) => {
            if (!blob) {
              throw new Error("Canvas is empty");
            }
            try {
              const item = new ClipboardItem({ "image/png": blob });
              await navigator.clipboard.write([item]);
              showFloatingAlert("圖片已成功複製到剪貼簿！");
            } catch (error) {
              console.error("複製到剪貼簿失敗:", error);
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'image.png';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
              showFloatingAlert("無法直接複製到剪貼簿，已自動下載圖片。");
            }
          }, "image/png");
        } catch (error) {
          console.error("截圖失敗:", error);
          showFloatingAlert("截圖失敗，請檢查瀏覽器控制台以獲取更多資訊。");
        }
      }

      // 建立防抖後的捕捉函數
      const debouncedCapture = debounce(captureAndCopyImage, 500);

      // 初始化
      textarea3.value = `red: #f24f24
blue: #24bbf2
green: #24f265`;

      textarea1.value = `銀<blue>行</blue>
重年
牛仔褲`;

      textarea2.value = `銀<red>航</red>
蟲年
牛<red>崽</red>褲`;

      updateTextElements(true);
      autoResizeTextarea(textarea1);
      autoResizeTextarea(textarea2);
      autoResizeTextarea(textarea3);

      // 事件監聽器
      textarea1.addEventListener("input", function () {
        textarea2.value = textarea1.value;
        updateTextElements();
        autoResizeTextarea(textarea1);
        autoResizeTextarea(textarea2);
        autoResizeTextarea(textarea3);
        debouncedCapture();
      });

      textarea2.addEventListener("input", function () {
        updateTextElements();
        autoResizeTextarea(textarea1);
        autoResizeTextarea(textarea2);
        autoResizeTextarea(textarea3);
        debouncedCapture();
      });

      textarea3.addEventListener("input", function () {
        updateTextElements();
        autoResizeTextarea(textarea1);
        autoResizeTextarea(textarea2);
        autoResizeTextarea(textarea3);
        debouncedCapture();
      });

      // 複製按鈕事件
      copyImageBtn.addEventListener("click", async function () {
        await captureAndCopyImage();
      });
    });  
  </script>
</body>

</html>
